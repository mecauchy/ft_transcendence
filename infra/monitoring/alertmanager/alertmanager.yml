# Prometheus Alertmanager Configuration
# Envoie les alertes vers Discord via webhook

global:
  # Temps de r√©solution automatique si plus d'alerte
  resolve_timeout: 5m

# Configuration du routing des alertes
route:
  # Groupe par d√©faut
  group_by: ['alertname', 'severity']
  # Attendre 30s avant d'envoyer le premier groupe d'alertes
  group_wait: 30s
  # Intervalle entre les groupes d'alertes
  group_interval: 5m
  # R√©p√©ter les alertes toutes les 4h
  repeat_interval: 4h
  # Receiver par d√©faut
  receiver: 'discord-notifications'
  
  # Routes sp√©cifiques par s√©v√©rit√©
  routes:
    # Alertes critiques - envoyer imm√©diatement
    - receiver: 'discord-critical'
      matchers:
        - severity = critical
      group_wait: 10s
      repeat_interval: 1h
    
    # Alertes warning
    - receiver: 'discord-notifications'
      matchers:
        - severity = warning
      group_wait: 1m
      repeat_interval: 4h

# Configuration des receivers (destinations)
receivers:
  # Receiver pour alertes normales/warning
  - name: 'discord-notifications'
    discord_configs:
      # Le webhook sera inject√© par l'entrypoint depuis Vault
      - webhook_url: 'VAULT_DISCORD_WEBHOOK_PLACEHOLDER'
        title: 'üü† {{ .Status | toUpper }} - {{ .CommonLabels.alertname }}'
        message: |
          {{ range .Alerts }}
          **Alerte:** {{ .Labels.alertname }}
          **S√©v√©rit√©:** {{ .Labels.severity }}
          **Instance:** {{ .Labels.instance }}
          **Description:** {{ .Annotations.description }}
          **D√©clench√©e √†:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ if .EndsAt }}**R√©solue √†:** {{ .EndsAt.Format "2006-01-02 15:04:05" }}{{ end }}
          ---
          {{ end }}
        send_resolved: true

  # Receiver pour alertes critiques
  - name: 'discord-critical'
    discord_configs:
      # Le webhook sera inject√© par l'entrypoint depuis Vault
      - webhook_url: 'VAULT_DISCORD_WEBHOOK_PLACEHOLDER'
        title: 'üî¥ CRITIQUE - {{ .CommonLabels.alertname }}'
        message: |
          üö® **ALERTE CRITIQUE** üö®
          {{ range .Alerts }}
          **Alerte:** {{ .Labels.alertname }}
          **S√©v√©rit√©:** {{ .Labels.severity }}
          **Service:** {{ .Labels.job }}
          **Instance:** {{ .Labels.instance }}
          
          üìù **R√©sum√©:** {{ .Annotations.summary }}
          üìã **Description:** {{ .Annotations.description }}
          
          ‚è∞ **D√©clench√©e:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          ---
          {{ end }}
        send_resolved: true

# R√®gles d'inhibition (√©vite les alertes redondantes)
inhibit_rules:
  # Si une alerte critical existe, inhiber les warnings du m√™me service
  - source_matchers:
      - severity = critical
    target_matchers:
      - severity = warning
    equal: ['alertname', 'instance']
