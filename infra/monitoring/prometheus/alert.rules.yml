# Prometheus Alert Rules
# R√®gles d'alertes pour surveiller les containers via cAdvisor

groups:
  # ============================================
  # GROUPE 1: Sant√© des Targets Prometheus
  # ============================================
  - name: prometheus_health
    rules:
      # Target inaccessible
      - alert: TargetDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Target {{ $labels.job }} est DOWN"
          description: "La target {{ $labels.instance }} du job {{ $labels.job }} est inaccessible depuis plus d'1 minute."

      # Prometheus lui-m√™me a des probl√®mes
      - alert: PrometheusConfigurationReloadFailure
        expr: prometheus_config_last_reload_successful != 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "√âchec du rechargement de la config Prometheus"
          description: "Prometheus n'a pas pu recharger sa configuration."

  # ============================================
  # GROUPE 2: Alertes CPU Containers
  # ============================================
  - name: container_cpu_alerts
    rules:
      # CPU √©lev√© (> 80%)
      - alert: ContainerHighCpuUsage
        expr: |
          (sum(rate(container_cpu_usage_seconds_total{name!=""}[5m])) by (name) 
          / sum(container_spec_cpu_quota{name!=""}/container_spec_cpu_period{name!=""}) by (name) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU √©lev√© sur {{ $labels.name }}"
          description: "Le container {{ $labels.name }} utilise {{ printf \"%.2f\" $value }}% du CPU depuis 5 minutes."

      # CPU critique (> 95%)
      - alert: ContainerCriticalCpuUsage
        expr: |
          (sum(rate(container_cpu_usage_seconds_total{name!=""}[5m])) by (name) 
          / sum(container_spec_cpu_quota{name!=""}/container_spec_cpu_period{name!=""}) by (name) * 100) > 95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "üî• CPU CRITIQUE sur {{ $labels.name }}"
          description: "URGENT: Le container {{ $labels.name }} utilise {{ printf \"%.2f\" $value }}% du CPU!"

      # Alternative plus simple si pas de limites CPU d√©finies
      - alert: ContainerHighCpuUsageSimple
        expr: sum(rate(container_cpu_usage_seconds_total{name!=""}[5m])) by (name) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU √©lev√© sur {{ $labels.name }}"
          description: "Le container {{ $labels.name }} utilise beaucoup de CPU: {{ printf \"%.2f\" $value }} cores."

  # ============================================
  # GROUPE 3: Alertes M√©moire Containers
  # ============================================
  - name: container_memory_alerts
    rules:
      # M√©moire √©lev√©e (> 80% de la limite)
      - alert: ContainerHighMemoryUsage
        expr: |
          (container_memory_usage_bytes{name!=""} 
          / container_spec_memory_limit_bytes{name!=""} * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "M√©moire √©lev√©e sur {{ $labels.name }}"
          description: "Le container {{ $labels.name }} utilise {{ printf \"%.2f\" $value }}% de sa limite m√©moire."

      # M√©moire critique (> 95% de la limite)
      - alert: ContainerCriticalMemoryUsage
        expr: |
          (container_memory_usage_bytes{name!=""} 
          / container_spec_memory_limit_bytes{name!=""} * 100) > 95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "üî• M√âMOIRE CRITIQUE sur {{ $labels.name }}"
          description: "URGENT: Le container {{ $labels.name }} utilise {{ printf \"%.2f\" $value }}% de sa m√©moire limite!"

      # M√©moire absolue √©lev√©e (> 1GB) - utile si pas de limite d√©finie
      - alert: ContainerHighMemoryAbsolute
        expr: container_memory_usage_bytes{name!=""} > 1073741824
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "M√©moire √©lev√©e sur {{ $labels.name }}"
          description: "Le container {{ $labels.name }} utilise plus de 1GB de m√©moire ({{ $value | humanize1024 }}B)."

  # ============================================
  # GROUPE 4: Alertes R√©seau Containers
  # ============================================
  - name: container_network_alerts
    rules:
      # Trafic r√©seau √©lev√© (> 100MB/s)
      - alert: ContainerHighNetworkTraffic
        expr: |
          sum(rate(container_network_receive_bytes_total{name!=""}[5m]) 
          + rate(container_network_transmit_bytes_total{name!=""}[5m])) by (name) > 104857600
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Trafic r√©seau √©lev√© sur {{ $labels.name }}"
          description: "Le container {{ $labels.name }} g√©n√®re plus de 100MB/s de trafic r√©seau ({{ $value | humanize1024 }}B/s)."

      # Erreurs r√©seau
      - alert: ContainerNetworkErrors
        expr: |
          sum(rate(container_network_receive_errors_total{name!=""}[5m]) 
          + rate(container_network_transmit_errors_total{name!=""}[5m])) by (name) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Erreurs r√©seau sur {{ $labels.name }}"
          description: "Le container {{ $labels.name }} a des erreurs r√©seau."

  # ============================================
  # GROUPE 5: Alertes √âtat des Containers
  # ============================================
  - name: container_state_alerts
    rules:
      # Container arr√™t√© (si cAdvisor ne le voit plus)
      - alert: ContainerAbsent
        expr: absent(container_last_seen{name!=""})
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Container non d√©tect√©"
          description: "Aucun container n'est d√©tect√© par cAdvisor. V√©rifiez l'√©tat des services."

      # Container qui red√©marre souvent
      - alert: ContainerFrequentRestart
        expr: |
          increase(container_start_time_seconds{name!=""}[1h]) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Red√©marrages fr√©quents de {{ $labels.name }}"
          description: "Le container {{ $labels.name }} a red√©marr√© plus de 3 fois dans la derni√®re heure."

  # ============================================
  # GROUPE 6: Alertes Disque Containers
  # ============================================
  - name: container_disk_alerts
    rules:
      # √âcriture disque √©lev√©e
      - alert: ContainerHighDiskWrite
        expr: |
          sum(rate(container_fs_writes_bytes_total{name!=""}[5m])) by (name) > 52428800
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "√âcriture disque √©lev√©e sur {{ $labels.name }}"
          description: "Le container {{ $labels.name }} √©crit plus de 50MB/s sur disque ({{ $value | humanize1024 }}B/s)."

      # Filesystem presque plein
      - alert: ContainerFilesystemFull
        expr: |
          (container_fs_usage_bytes{name!=""} 
          / container_fs_limit_bytes{name!=""} * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Filesystem presque plein sur {{ $labels.name }}"
          description: "Le filesystem du container {{ $labels.name }} est utilis√© √† {{ printf \"%.2f\" $value }}%."
