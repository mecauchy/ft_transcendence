# Override file for docker-compose.yml in PRODUCTION environment
# Use with: docker compose -f docker-compose.yml -f docker-compose.prod.yml up

services:
  # VAULT SERVICE - PRODUCTION MODE
  vault:
    # Use file-based storage with proper configuration
    command: ["vault", "server", "-config=/vault/config/vault.hcl"]
    volumes:
      - vault_data:/vault/file
      - ./infra/vault/vault.hcl:/vault/config/vault.hcl:ro
      - ./infra/secrets:/run/secrets:ro
    environment:
      VAULT_ADDR: https://vault:8200
      VAULT_SKIP_VERIFY: "false"
      VAULT_LOG_LEVEL: info
    # Don't expose ports in production, use ingress/load balancer
    ports: []
    # Require init/unseal in production
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "https://localhost:8200/v1/sys/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # PostgreSQL SERVICE - PRODUCTION MODE
  postgres:
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_db_pass.txt
      POSTGRES_INITDB_ARGS: "-c ssl=on -c ssl_cert_file=/var/lib/postgresql/server.crt -c ssl_key_file=/var/lib/postgresql/server.key"
    volumes:
      - ./infra/secrets:/run/secrets:ro
      - postgres_data:/var/lib/postgresql/data
    # Don't expose port directly in production
    ports: []
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U root_admin -h localhost"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Redis SERVICE - PRODUCTION MODE
  redis:
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      - redis_data:/data
    # Don't expose port directly in production
    ports: []
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # WAF SERVICE - PRODUCTION MODE
  waf:
    environment:
      # Use real TLS certificates in production
      - ENABLE_TLS=true
      - SSL_CERT_PATH=/etc/ssl/certs/server.crt
      - SSL_KEY_PATH=/etc/ssl/private/server.key
    volumes:
      - ./infra/certs:/etc/ssl/certs:ro
    # Don't expose HTTP directly, only HTTPS
    ports:
      - "443:443"  # HTTPS only

  api-gateway:
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=info
      - VAULT_ADDR=https://vault:8200

